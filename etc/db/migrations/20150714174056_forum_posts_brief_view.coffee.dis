exports.up = (knex, Promise) ->
  sql = "
    CREATE view forum_topic_brief_view AS
      SELECT
        t.title, t.slug, t.status, t.votes, t.language,
        u.username, u.email AS user_email,
        t.view_count, pcount.posts_count,
        last_post.post AS last_post_excerpt
        FROM
          users AS u, forum_topics AS t,
          forum_posts_topic_count_view AS posts_count,
          (
            SELECT
              t.id as topic,
              count(p.id) as posts_count
              FROM
                forum_topics AS t,
                forum_posts AS p
              WHERE t.id = p.topic
              GROUP BY t.id
          ) AS pcount,
          (
            SELECT DISTINCT ON (topic)
              t.id as topic,
              p.id as post
              -- p.excerpt
              FROM
                forum_topics AS t,
                forum_posts AS p
              WHERE t.id = p.topic
              ORDER BY t.id ASC, p.id DESC
          ) AS last_post
        WHERE
          u.id = t.created_by AND
          t.id = pcount.topic AND
          t.id = last_post.topic"

  console.log sql
  knex.raw sql

exports.down = (knex, Promise) -> knex.raw "DROP VIEW forum_topic_brief_view"
