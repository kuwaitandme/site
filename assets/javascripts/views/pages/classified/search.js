window.a = [{"_id":"54f7596c654442980b222067","status":1,"guest":false,"owner":"54f6a587ceeceab61441fecf","views":0,"created":"2015-03-04T19:13:48.799Z","type":0,"title":"asd","price":0,"description":"<p><b>Your description goes here</b></p><p>You have a lot of options to make you classified look pretty and appealing! Choose from any of the formatting options above.</p><p>Avoid writing contact details and the price for your classified as we will let you mention them in the next page.</p>","category":"54e0d9ee71d39c8acf2a1444","__v":0,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"urgent":false,"promote":false},"reports":[],"images":[]},{"_id":"54f75920b2518dd80aaf6fda","status":1,"guest":false,"owner":"54f6a587ceeceab61441fecf","views":0,"created":"2015-03-04T19:12:32.990Z","type":0,"title":"asdsa","price":0,"description":"<p><b>Your description goes here</b></p><p>You have a lot of options to make you classified look pretty and appealing! Choose from any of the formatting options above.</p><p>Avoid writing contact details and the price for your classified as we will let you mention them in the next page.</p>","category":"54e0d9ee71d39c8acf2a1444","__v":0,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"urgent":false,"promote":false},"reports":[],"images":[]},{"_id":"54f753860f05feb673ee78ac","status":1,"guest":false,"owner":"54f6a587ceeceab61441fecf","views":0,"created":"2015-03-04T18:48:38.562Z","type":0,"title":"A new ss","price":0,"description":"<p><b>Your description goes here</b></p><p>You have a lot of options to make you classified look pretty and appealing! Choose from any of the formatting options above.</p><p>Avoid writing contact details and the price for your classified as we will let you mention them in the next page.</p>","category":"54e0d9ee71d39c8acf2a1444","__v":0,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"urgent":false,"promote":false},"reports":[],"images":[]},{"_id":"54f6b9b605ab90cc58981752","status":1,"guest":false,"owner":"54f6a587ceeceab61441fecf","views":0,"created":"2015-03-04T07:52:22.542Z","type":0,"title":"A new day","price":0,"description":"<p><b>Your description goes here</b></p><p>You have a lot of options to make you classified look pretty and appealing! Choose from any of the formatting options above.</p><p>Avoid writing contact details and the price for your classified as we will let you mention them in the next page.</p>","category":"54e0d9ee71d39c8acf2a1444","__v":0,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"urgent":false,"promote":false},"reports":[],"images":[]},{"_id":"54e70c66a18a20727b0b739b","__v":1,"adminReason":"","category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-20T10:28:54.029Z","description":"asda ds asd sa ","flaggersIP":[],"guest":false,"owner":"54e0422eb718216e44bbab6e","price":0,"status":1,"title":"Hello from jonny","type":0,"views":30,"flags":[{"_id":"54eb4797e2f9ed3b56e5894f","reason":"56","ip":"127.0.0.1"}],"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"","location":"54e0d9ee71d39c8acf2a1524","email":"a@mail.com"},"perks":{"promote":false,"urgent":true},"reports":[],"images":["E1kSQ97UNQhWIV.png","2KEl0bZ2nuJWeP.png","OCGsPmwEBt7lbx.png"]},{"_id":"54e29d68a9e7c79c0b50070c","__v":1,"category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-17T01:46:16.645Z","description":"a@mail.com\nsadhaksjdhkasjdh asdha\n","flaggersIP":[],"guest":false,"owner":"54e0422eb718216e44bbab6e","price":0,"status":1,"title":"a@mail.com","type":0,"views":16,"flags":[{"_id":"54eb4799e2f9ed3b56e58950","reason":"56","ip":"127.0.0.1"}],"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"123","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"promote":false,"urgent":false},"reports":[],"images":[]},{"_id":"54e29af68df8f469088d2d4c","__v":0,"adminReason":"","category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-17T01:35:50.444Z","description":"asd21e","flaggersIP":[],"guest":false,"owner":"54e03200a945f989362b1f68","price":0,"status":1,"title":"asdas","type":1,"views":3,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"12312","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"promote":false,"urgent":false},"reports":[],"images":[]},{"_id":"54e17c75f0aef0825bec7db8","__v":0,"category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-16T05:13:25.700Z","description":"asd","flaggersIP":[],"guest":true,"price":0,"status":1,"title":"Hello","type":1,"views":1,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"231","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mcil.com","address2":"","address1":""},"perks":{"promote":false,"urgent":false},"reports":[],"images":[]},{"_id":"54e17b7f374c6d66594803a2","__v":0,"category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-16T05:09:19.807Z","description":"asd","flaggersIP":[],"guest":true,"price":0,"status":1,"title":"abc","type":1,"views":2,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"213","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com","address2":"","address1":""},"perks":{"promote":true,"urgent":true},"reports":[],"images":[]},{"_id":"54e10c5aee6d54cc2c26d853","__v":0,"category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-15T21:15:06.846Z","description":"asda sda sda sd ","flaggersIP":[],"guest":true,"price":12312,"status":1,"title":"Thiwhfi hfksj skjdh skdjfh","type":1,"views":3,"meta":{"gmapY":48.01846895263668,"gmapX":29.286138472660404},"contact":{"phone":"123123 123 123","location":"54e0d9ee71d39c8acf2a14da","email":"a@mail.com"},"perks":{"promote":false,"urgent":true},"reports":[],"images":["jxqTCeLwraeZlh.png","TrYglAc1I3rF9B.png","ymUFiVcRI8R6ct.png","bGYyYkgY2x1GeC.png"]},{"__v":0,"_id":"54e10a9cb232a6b527886af0","adminReason":"I don't like your face","category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-15T21:07:40.381Z","description":"asd","flaggersIP":[],"guest":true,"price":123,"status":1,"title":"Testting","type":1,"views":3,"meta":{"gmapY":null,"gmapX":null},"contact":{"phone":"123","location":"54e0d9ee71d39c8acf2a14e0","email":"a@mail.com"},"perks":{"promote":false,"urgent":false},"reports":[],"images":["mQD1H1dGVbvChe.png","wJXT1a6xrv01Wz.png","DBeAp7qTqijqrw.png","NZZoSweP3OUtJh.png"]},{"_id":"54e0edd16bbf4aa24bb3b7c0","__v":0,"category":"54e0d9ee71d39c8acf2a1444","created":"2015-02-15T19:04:49.775Z","description":"asd","flaggersIP":[],"guest":true,"price":123,"status":1,"title":"Hello World","type":1,"views":7,"contact":{"phone":"123","location":"54e0d9ee71d39c8acf2a14d8","email":"a@mail.com"},"perks":{"promote":false,"urgent":false},"reports":[],"images":["FyVbYyiEnh5saU.png","igOJOzzykQkZMY.gif","QT1kFvc9R1DPNo.png","N9zvUWpwzlofuq.png","OFQuBu37MFwBIg.png"]}];

module.exports = controller = Backbone.View.extend({
	gridMinimumSize: 250,

	initialize: function(objs) {
		var that = this;

		if(objs.$el) this.$el = objs.$el;
		console.log(objs, this.$el, this.$el.html());
		this.pageIndex = 1;
		this.ajaxLock = false;
		this.ajaxDisable = false;

		// Do something with the GET parameters here..
		// var url = document.URL;
		// this.get = app.helpers.url.getGETstring(url);
		this.$classifiedList = this.$el.find("ul#classified-search");

		this.setupMasonry();
		this.render();
		// this.spinner = new app.views.components.spinner();

		this.fireAjaxEvent();
		$(window).scroll(function() {
			that.fireAjaxEvent();
		});
		$(window).resize(function() {
			that.resizeClassifieds();
		});
	},


	render: function () {
		this.listTemplate = _.template(this.$el.find("#list-template").html());
		// this.addClassifieds(window.data.classifieds);
		this.addClassifieds(a);
		this.resizeClassifieds();
	},


	resizeClassifieds: function () {
		/* Calculate the width of a single 1x1 sqaure. Subtract 5px from the
		 * window's width to compensate for the scroll bar */
		var windowWidth = $(window).width() - 50;
		var columns = Math.floor(windowWidth / this.gridMinimumSize);
		var excessSpace = windowWidth - (this.gridMinimumSize * columns);
		var finalSize = Math.floor(this.gridMinimumSize + (excessSpace / columns));

		/* Set each of the blocks with the right size */
		this.$el.find(".classified").width(finalSize);
	},


	/**
	 * [fireAjaxEvent description]
	 *
	 * @return {[type]} [description]
	 */
	fireAjaxEvent: function() {
		if ($(window).scrollTop() >= ($(document).height() - $(window).height())*0.9) {
			this.ajaxLoadClassifieds();
		}
	},


	/**
	 * [ajaxLoadClassifieds description]
	 *
	 * @return {[type]} [description]
	 */
	ajaxLoadClassifieds: function() {
		if(this.ajaxLock || this.ajaxDisable) return;
		var that = this;

		this.ajaxLock = true;
		// this.spinner.show();
		this.pageIndex += 1;

		var url = app.helpers.url.insertParam("page", this.pageIndex);

		$.ajax({
			url: url,
			type: 'POST',
			data: { _csrf: window._csrf },
			dataType: 'json',
			success: function (data) {
				/* Add the classifieds and remove the lock after a delay of
				 * 500ms. This is because we want to avoid the AJAX request being
				 * fired again as masonry is still aligning the elements */
				if(data.classifieds && data.classifieds.length > 0) {
					that.addClassifieds(data.classifieds);
				} else {
					that.showClassifiedsEnd();
				}

				setTimeout(function() {
					// that.spinner.hide();
					that.ajaxLock = false;

					/* Fire the AJAX event again! */
					that.fireAjaxEvent();
				}, 500);
			}
		});
	},


	/**
	 * [showClassifiedsEnd description]
	 * @return {[type]} [description]
	 */
	showClassifiedsEnd: function() {
		this.ajaxDisable = true;
	},


	/**
	 * Sets up the Masonry objects
	 */
	setupMasonry: function () {
		this.$classifiedList.masonry({
			// columnWidth: 290,
			// gutter: 0,
			isFitWidth: true,
			isAnimated: true,
			itemSelector: '.classified',
		});
	},


	/**
	 * [addClassifieds description]
	 *
	 * @param {[type]} classifieds [description]
	 */
	addClassifieds: function(classifieds) {
		var that = this;
		var elems;


		var fragement = document.createDocumentFragment();

		/* For each classified, apply the template and append it into the
		 * container */
		_.each(classifieds, function(post) {
			post.price = app.helpers.price.format(post.price);
			post.created = app.helpers.date.prettify(post.created);

			if(!post.perks) post.perks = {};
			if(!post.title) post.title = '';

			var html = that.listTemplate(post);

			// var $el = $('<div class="classified w2">asd</div>');//$(html);
			var elem = $(html);
			 elems = elems ? elems.add( elem ) : elem;
		});

		that.$classifiedList.append(elems);
		that.$classifiedList.masonry("appended", elems);
		that.$classifiedList.masonry();

		/* Reload, every time an image has been loaded */
		var reloadMasonry = function() {
			that.$classifiedList.masonry();
		};
		imagesLoaded(this.$classifiedList, reloadMasonry);
	}
});